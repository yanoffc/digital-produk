// Optimized Combined JavaScript - All in One
(function(){'use strict';
const ADMIN={username:'RifalosID',password:'admin123'};
let products=[],currentEditId=null,currentDeleteId=null;
let settings={whatsappNumber:'6281234567890',tripayApiKey:'',tripayPrivateKey:'',tripayMerchantCode:'',tripayMode:'sandbox',paymentVerification:'auto',paymentTimeout:30,autoRefund:'enabled',paymentWebhook:'',paymentSecret:'',minPaymentAmount:10000,maxPaymentAmount:100000000,enablePaymentLogging:true,enableEmailNotification:true,callbackUrl:'',returnUrl:'',callbackSecret:'',enableCallback:true,enableCallbackLogging:true};

// Auth System
class Auth{constructor(){this.maxAttempts=3;this.lockoutTime=30*60*1000;this.sessionTimeout=60*60*1000;}
async hashPassword(p,s){const e=new TextEncoder(),d=e.encode(p+(s||''));const h=await crypto.subtle.digest('SHA-256',d),a=Array.from(new Uint8Array(h));return a.map(b=>b.toString(16).padStart(2,'0')).join('');}
generateToken(u){const t=Date.now(),r=Math.random().toString(36).substring(2,15);return btoa(`${u}:${t}:${r}`).replace(/[^a-zA-Z0-9]/g,'');}
checkSession(){const s=sessionStorage.getItem('adminSession');if(!s)return false;try{const d=JSON.parse(s);if(!d||!d.loginTime)return false;const n=Date.now(),l=new Date(d.loginTime).getTime();if(isNaN(l))return false;if(n-l>this.sessionTimeout){this.logout();return false;}d.lastActivity=n;sessionStorage.setItem('adminSession',JSON.stringify(d));return true;}catch(e){return false;}}
createSession(u,t){const s={username:u,token:t,loginTime:new Date().toISOString(),lastActivity:Date.now(),sessionId:'sess_'+Date.now()+'_'+Math.random().toString(36).substring(2,15)};try{sessionStorage.setItem('adminSession',JSON.stringify(s));localStorage.setItem('adminLoggedIn','true');return true;}catch(e){return false;}}
logout(){localStorage.removeItem('adminLoggedIn');sessionStorage.removeItem('adminSession');window.location.href='login.html';}
checkRateLimit(){const a=this.loadAttempts();if(a.lockedUntil&&Date.now()<a.lockedUntil){const m=Math.ceil((a.lockedUntil-Date.now())/1000/60);return{allowed:false,message:`Terlalu banyak percobaan. Coba lagi dalam ${m} menit.`};}return{allowed:true};}
loadAttempts(){const s=localStorage.getItem('loginAttempts');if(s){const a=JSON.parse(s);if(a.lockedUntil&&Date.now()<a.lockedUntil)return a;if(a.lockedUntil&&Date.now()>=a.lockedUntil)this.resetAttempts();}return{count:0,lockedUntil:null};}
incrementAttempts(){const a=this.loadAttempts();a.count=(a.count||0)+1;if(a.count>=this.maxAttempts){a.lockedUntil=Date.now()+this.lockoutTime;this.saveAttempts(a);return{locked:true,remainingTime:Math.ceil((a.lockedUntil-Date.now())/1000/60)};}this.saveAttempts(a);return{locked:false,remainingAttempts:this.maxAttempts-a.count};}
saveAttempts(a){localStorage.setItem('loginAttempts',JSON.stringify(a));}
resetAttempts(){localStorage.removeItem('loginAttempts');}}

const auth=new Auth();

// Access Control
function checkAccess(){const s=sessionStorage.getItem('adminSession');if(!s)return false;try{const d=JSON.parse(s);if(d.username!=='RifalosID'){auth.logout();return false;}return auth.checkSession();}catch(e){return false;}}

// Product Management
function loadProducts(){const s=localStorage.getItem('products');products=s?JSON.parse(s):[];}
function saveProducts(){try{localStorage.setItem('products',JSON.stringify(products));if(typeof renderProducts==='function')renderProducts();if(typeof updateStats==='function')updateStats();return true;}catch(e){alert('Gagal menyimpan!');return false;}}
function loadSettings(){const s=localStorage.getItem('adminSettings');if(s)try{settings={...settings,...JSON.parse(s)};}catch(e){}}
function saveSettingsToStorage(){localStorage.setItem('adminSettings',JSON.stringify(settings));}

function formatNumber(n){return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');}
function getStockStatus(s,t){if(s===0)return'out-of-stock';if(s<(t||10))return'low-stock';return'in-stock';}
function getStatusBadge(s){const b={'in-stock':'<span class="status-badge in-stock">Tersedia</span>','low-stock':'<span class="status-badge low-stock">Stok Menipis</span>','out-of-stock':'<span class="status-badge out-of-stock">Habis</span>'};return b[s]||b['in-stock'];}

function renderProducts(){const t=document.getElementById('productsTableBody');if(!t)return;if(products.length===0){t.innerHTML='<tr><td colspan="7" class="empty-state"><i class="fas fa-inbox"></i><p>Belum ada produk.</p></td></tr>';return;}
t.innerHTML=products.map((p,i)=>{const s=getStockStatus(p.stock,p.lowStockThreshold||10);return`<tr><td>${i+1}</td><td><strong>${escapeHtml(p.name)}</strong></td><td>${escapeHtml(p.category)}</td><td>Rp ${formatNumber(p.price)}</td><td><div class="stock-control"><button class="btn-stock btn-minus" onclick="updateStock(${p.id},-1)"><i class="fas fa-minus"></i></button><input type="number" class="stock-input" value="${p.stock}" min="0" onchange="quickUpdateStock(${p.id},this.value)" onblur="quickUpdateStock(${p.id},this.value)"><button class="btn-stock btn-plus" onclick="updateStock(${p.id},1)"><i class="fas fa-plus"></i></button></div></td><td>${getStatusBadge(s)}</td><td><div class="action-buttons"><button class="btn-action btn-edit" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i> Edit</button><button class="btn-action btn-delete" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i> Hapus</button></div></td></tr>`;}).join('');}

function updateStats(){const t=document.getElementById('totalProducts'),s=document.getElementById('totalStock'),l=document.getElementById('lowStock');if(!t||!s||!l)return;const tp=products.length,ts=products.reduce((a,p)=>a+parseInt(p.stock||0),0),ls=products.filter(p=>{const th=p.lowStockThreshold||10;return p.stock>0&&p.stock<th;}).length;t.textContent=tp;s.textContent=formatNumber(ts);l.textContent=ls;}

function quickUpdateStock(id,v){const p=products.find(x=>x.id===id);if(!p)return;const s=parseInt(v)||0;if(s<0){alert('Stok tidak boleh negatif!');renderProducts();return;}p.stock=s;p.updatedAt=new Date().toISOString();saveProducts();showNotification(`Stok ${p.name} diperbarui menjadi ${s}`,'success');}
function updateStock(id,c){const p=products.find(x=>x.id===id);if(!p)return;const s=Math.max(0,(p.stock||0)+c);p.stock=s;p.updatedAt=new Date().toISOString();saveProducts();showNotification(`Stok ${p.name} ${c>0?'ditambah':'dikurangi'} menjadi ${s}`,'success');}

function openAddModal(){try{currentEditId=null;const m=document.getElementById('modalTitle'),f=document.getElementById('productForm');if(m)m.textContent='Tambah Produk Baru';if(f)f.reset();['productId','productName','productCategory','productPrice','productStock','productDescription'].forEach(x=>{const el=document.getElementById(x);if(el)el.value='';});const lt=document.getElementById('lowStockThreshold');if(lt)lt.value='10';const pm=document.getElementById('productModal');if(pm)pm.classList.add('show');setTimeout(()=>{const ni=document.getElementById('productName');if(ni)ni.focus();},100);}catch(e){alert('Gagal membuka form!');}}
function editProduct(id){const p=products.find(x=>x.id===id);if(!p)return;currentEditId=id;const m=document.getElementById('modalTitle');if(m)m.textContent='Edit Produk';const pi=document.getElementById('productId');if(pi)pi.value=p.id;const pn=document.getElementById('productName');if(pn)pn.value=p.name;const pc=document.getElementById('productCategory');if(pc)pc.value=p.category;const pp=document.getElementById('productPrice');if(pp)pp.value=p.price;const ps=document.getElementById('productStock');if(ps)ps.value=p.stock;const pd=document.getElementById('productDescription');if(pd)pd.value=p.description||'';const lt=document.getElementById('lowStockThreshold');if(lt)lt.value=p.lowStockThreshold||10;const pm=document.getElementById('productModal');if(pm)pm.classList.add('show');}
function saveProduct(e){e.preventDefault();const n=document.getElementById('productName'),c=document.getElementById('productCategory'),p=document.getElementById('productPrice'),s=document.getElementById('productStock');if(!n||!c||!p||!s){alert('Form tidak lengkap!');return;}const name=n.value.trim(),category=c.value,price=parseInt(p.value)||0,stock=parseInt(s.value)||0;if(!name){alert('Nama produk harus diisi!');n.focus();return;}if(!category){alert('Kategori harus dipilih!');c.focus();return;}if(price<0){alert('Harga tidak boleh negatif!');p.focus();return;}if(stock<0){alert('Stok tidak boleh negatif!');s.focus();return;}const id=currentEditId||Date.now(),pd=document.getElementById('productDescription'),lt=document.getElementById('lowStockThreshold');const prod={id:currentEditId||id,name:name,category:category,price:price,stock:stock,description:pd?pd.value.trim():'',lowStockThreshold:lt?parseInt(lt.value)||10:10,updatedAt:new Date().toISOString()};if(currentEditId){const i=products.findIndex(x=>x.id===currentEditId);if(i!==-1)products[i]={...products[i],...prod};}else{prod.createdAt=new Date().toISOString();products.push(prod);}if(saveProducts()){closeModal();showNotification(currentEditId?'Produk berhasil diperbarui!':'Produk berhasil ditambahkan!','success');}else{alert('Gagal menyimpan!');}}
function deleteProduct(id){const p=products.find(x=>x.id===id);if(!p)return;currentDeleteId=id;const dn=document.getElementById('deleteProductName');if(dn)dn.textContent=p.name;const dm=document.getElementById('deleteModal');if(dm)dm.classList.add('show');}
function confirmDelete(){if(currentDeleteId){products=products.filter(p=>p.id!==currentDeleteId);saveProducts();closeDeleteModal();showNotification('Produk berhasil dihapus!','success');}}
function closeModal(){try{const pm=document.getElementById('productModal');if(pm)pm.classList.remove('show');currentEditId=null;const f=document.getElementById('productForm');if(f)f.reset();}catch(e){}}
function closeDeleteModal(){const dm=document.getElementById('deleteModal');if(dm)dm.classList.remove('show');currentDeleteId=null;}

function openSettings(){loadSettings();const wn=document.getElementById('whatsappNumber');if(wn)wn.value=settings.whatsappNumber||'';const tak=document.getElementById('tripayApiKey');if(tak)tak.value=settings.tripayApiKey||'';const tpk=document.getElementById('tripayPrivateKey');if(tpk)tpk.value=settings.tripayPrivateKey||'';const tmc=document.getElementById('tripayMerchantCode');if(tmc)tmc.value=settings.tripayMerchantCode||'';const tm=document.getElementById('tripayMode');if(tm)tm.value=settings.tripayMode||'sandbox';const pv=document.getElementById('paymentVerification');if(pv)pv.value=settings.paymentVerification||'auto';const pt=document.getElementById('paymentTimeout');if(pt)pt.value=settings.paymentTimeout||30;const ar=document.getElementById('autoRefund');if(ar)ar.value=settings.autoRefund||'enabled';const pw=document.getElementById('paymentWebhook');if(pw)pw.value=settings.paymentWebhook||'';const ps=document.getElementById('paymentSecret');if(ps)ps.value=settings.paymentSecret||'';const mpa=document.getElementById('minPaymentAmount');if(mpa)mpa.value=settings.minPaymentAmount||10000;const mxa=document.getElementById('maxPaymentAmount');if(mxa)mxa.value=settings.maxPaymentAmount||100000000;const epl=document.getElementById('enablePaymentLogging');if(epl)epl.checked=settings.enablePaymentLogging!==false;const een=document.getElementById('enableEmailNotification');if(een)een.checked=settings.enableEmailNotification!==false;const cu=document.getElementById('callbackUrl');if(cu)cu.value=settings.callbackUrl||'';const ru=document.getElementById('returnUrl');if(ru)ru.value=settings.returnUrl||'';const cs=document.getElementById('callbackSecret');if(cs)cs.value=settings.callbackSecret||'';const ec=document.getElementById('enableCallback');if(ec)ec.checked=settings.enableCallback!==false;const ecl=document.getElementById('enableCallbackLogging');if(ecl)ecl.checked=settings.enableCallbackLogging!==false;const sm=document.getElementById('settingsModal');if(sm)sm.classList.add('show');}
function closeSettings(){const sm=document.getElementById('settingsModal');if(sm)sm.classList.remove('show');}
function saveSettings(e){e.preventDefault();const wn=document.getElementById('whatsappNumber');if(wn)settings.whatsappNumber=wn.value.trim();const tak=document.getElementById('tripayApiKey');if(tak)settings.tripayApiKey=tak.value.trim();const tpk=document.getElementById('tripayPrivateKey');if(tpk)settings.tripayPrivateKey=tpk.value.trim();const tmc=document.getElementById('tripayMerchantCode');if(tmc)settings.tripayMerchantCode=tmc.value.trim();const tm=document.getElementById('tripayMode');if(tm)settings.tripayMode=tm.value;const pv=document.getElementById('paymentVerification');if(pv)settings.paymentVerification=pv.value;const pt=document.getElementById('paymentTimeout');if(pt)settings.paymentTimeout=parseInt(pt.value)||30;const ar=document.getElementById('autoRefund');if(ar)settings.autoRefund=ar.value;const pw=document.getElementById('paymentWebhook');if(pw)settings.paymentWebhook=pw.value.trim();const ps=document.getElementById('paymentSecret');if(ps)settings.paymentSecret=ps.value.trim();const mpa=document.getElementById('minPaymentAmount');if(mpa)settings.minPaymentAmount=parseInt(mpa.value)||10000;const mxa=document.getElementById('maxPaymentAmount');if(mxa)settings.maxPaymentAmount=parseInt(mxa.value)||100000000;const epl=document.getElementById('enablePaymentLogging');if(epl)settings.enablePaymentLogging=epl.checked;const een=document.getElementById('enableEmailNotification');if(een)settings.enableEmailNotification=een.checked;const cu=document.getElementById('callbackUrl');if(cu)settings.callbackUrl=cu.value.trim();const ru=document.getElementById('returnUrl');if(ru)settings.returnUrl=ru.value.trim();const cs=document.getElementById('callbackSecret');if(cs)settings.callbackSecret=cs.value.trim();const ec=document.getElementById('enableCallback');if(ec)settings.enableCallback=ec.checked;const ecl=document.getElementById('enableCallbackLogging');if(ecl)settings.enableCallbackLogging=ecl.checked;if(settings.minPaymentAmount>=settings.maxPaymentAmount){alert('Minimum harus lebih kecil dari maximum!');return;}if(settings.paymentTimeout<5||settings.paymentTimeout>1440){alert('Payment timeout harus antara 5-1440 menit!');return;}saveSettingsToStorage();closeSettings();showNotification('Settings berhasil disimpan!','success');}

function showNotification(m,t='success'){const n=document.createElement('div');n.className=`notification notification-${t}`;n.innerHTML=`<i class="fas fa-${t==='success'?'check-circle':'exclamation-circle'}"></i><span>${m}</span>`;n.style.cssText=`position:fixed;top:20px;right:20px;background:${t==='success'?'#27ae60':'#e74c3c'};color:white;padding:15px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;display:flex;align-items:center;gap:10px;animation:slideInRight 0.3s;`;document.body.appendChild(n);setTimeout(()=>{n.style.animation='slideOutRight 0.3s';setTimeout(()=>{if(n.parentNode)document.body.removeChild(n);},300);},3000);}

function filterProducts(){const si=document.getElementById('searchInput'),tb=document.getElementById('productsTableBody');if(!si||!tb)return;const t=si.value.toLowerCase();if(products.length===0){renderProducts();return;}const f=products.filter(p=>p.name.toLowerCase().includes(t)||p.category.toLowerCase().includes(t));if(f.length===0){tb.innerHTML='<tr><td colspan="7" class="empty-state"><i class="fas fa-search"></i><p>Produk tidak ditemukan.</p></td></tr>';return;}tb.innerHTML=f.map((p,i)=>{const s=getStockStatus(p.stock,p.lowStockThreshold||10);return`<tr><td>${i+1}</td><td><strong>${escapeHtml(p.name)}</strong></td><td>${escapeHtml(p.category)}</td><td>Rp ${formatNumber(p.price)}</td><td><div class="stock-control"><button class="btn-stock btn-minus" onclick="updateStock(${p.id},-1)"><i class="fas fa-minus"></i></button><input type="number" class="stock-input" value="${p.stock}" min="0" onchange="quickUpdateStock(${p.id},this.value)"><button class="btn-stock btn-plus" onclick="updateStock(${p.id},1)"><i class="fas fa-plus"></i></button></div></td><td>${getStatusBadge(s)}</td><td><div class="action-buttons"><button class="btn-action btn-edit" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i> Edit</button><button class="btn-action btn-delete" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i> Hapus</button></div></td></tr>`;}).join('');}

function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}

// Authentication
async function authenticate(u,p){const r=auth.checkRateLimit();if(!r.allowed)return{success:false,message:r.message};if(u!=='RifalosID'){const a=auth.incrementAttempts();return{success:false,message:a.locked?`Terlalu banyak percobaan. Coba lagi dalam ${a.remainingTime} menit.`:`Username atau password salah! (${a.remainingAttempts} percobaan tersisa)`};}const h=await auth.hashPassword(p);let stored=localStorage.getItem('adminAccount');if(!stored){const h2=await auth.hashPassword(ADMIN.password);stored=btoa(JSON.stringify({username:ADMIN.username,passwordHash:h2}));localStorage.setItem('adminAccount',stored);}const acc=JSON.parse(atob(stored));if(h!==acc.passwordHash){const a=auth.incrementAttempts();return{success:false,message:a.locked?`Terlalu banyak percobaan. Coba lagi dalam ${a.remainingTime} menit.`:`Username atau password salah! (${a.remainingAttempts} percobaan tersisa)`};}auth.resetAttempts();const t=auth.generateToken(u);auth.createSession(u,t);return{success:true,token:t,username:u};}

// Check Auth (for admin panel)
function checkAuth(){const l=localStorage.getItem('adminLoggedIn'),s=sessionStorage.getItem('adminSession');if(!l||l!=='true'||!s){window.location.href='login.html';return false;}try{const d=JSON.parse(s);if(!d||!d.username||d.username!=='RifalosID'){auth.logout();return false;}if(!auth.checkSession()){auth.logout();return false;}d.lastActivity=Date.now();sessionStorage.setItem('adminSession',JSON.stringify(d));return true;}catch(e){auth.logout();return false;}}

// Inactivity Timer
let inactivityTimer;
function resetInactivityTimer(){clearTimeout(inactivityTimer);inactivityTimer=setTimeout(()=>{if(confirm('Tidak ada aktivitas dalam 30 menit. Apakah Anda ingin tetap login?')){resetInactivityTimer();}else{auth.logout();}},30*60*1000);}
if(typeof document!=='undefined'){document.addEventListener('mousemove',resetInactivityTimer);document.addEventListener('keypress',resetInactivityTimer);document.addEventListener('click',resetInactivityTimer);}

// Initialize
if(typeof window!=='undefined'){window.Auth=Auth;window.auth=auth;window.checkAccess=checkAccess;window.checkAuth=checkAuth;window.loadProducts=loadProducts;window.saveProducts=saveProducts;window.renderProducts=renderProducts;window.updateStats=updateStats;window.openAddModal=openAddModal;window.editProduct=editProduct;window.saveProduct=saveProduct;window.deleteProduct=deleteProduct;window.confirmDelete=confirmDelete;window.closeModal=closeModal;window.closeDeleteModal=closeDeleteModal;window.openSettings=openSettings;window.closeSettings=closeSettings;window.saveSettings=saveSettings;window.quickUpdateStock=quickUpdateStock;window.updateStock=updateStock;window.filterProducts=filterProducts;window.showNotification=showNotification;window.authenticate=authenticate;window.logout=()=>auth.logout();window.resetInactivityTimer=resetInactivityTimer;window.escapeHtml=escapeHtml;}
})();
